{% extends 'base.html' %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/staff_dashboard.css') }}">
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* Adjust filter icon and input styles to be inline */
        .filter-header {
            display: inline-flex;
            align-items: center;
            gap: 5px; /* Space between text and icon */
        }
    
        .filter-container {
            display: none;
            position: absolute;
            top: -25px;  /* Move the filter container above the icon */
            left: 0;
            z-index: 999;  /* High z-index to ensure it's on top */
            background-color: white;
            padding: 5px;
            box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            width: 160px;  /* Increase the width of the filter box */
        }
    
        .filter-icon {
            cursor: pointer;
            font-size: 0.9em; /* Adjust icon size */
        }
    
        .filter-input {
            width: 100%;
        }
    
        th {
            position: relative;
        }
    
        /* Ensure only one filter input is shown at a time */
        .filter-container.active {
            display: block;
        }
    
        /* Fix clipping issue in case of overflow */
        .table-container {
            position: relative;
            overflow: visible;
        }

        /* Style the Clear Filters button */
        .clear-filters {
            margin-top: 10px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-content">
    <h1>Staff Dashboard</h1>
    <button id="toggleAdvancedSearch" class="btn btn-primary mb-3">Advanced Search</button> <!--toggle advanced search-->
    <div id="advancedSearchForm" style="display: none;">
        <form id="searchForm" class="mb-4">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control" name="username" placeholder="Username">
                </div>
                <div class="col-md-4 mb-3">
                    <input type="email" class="form-control" name="email" placeholder="Email">
                </div>
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control" name="address" placeholder="Address">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control" name="contact_number" placeholder="Contact Number">
                </div>
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control" name="patient_name" placeholder="Patient Name">
                </div>
                <div class="col-md-4 mb-3">
                    <input type="text" class="form-control" name="nric" placeholder="NRIC">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <select class="form-control" name="gender">
                        <option value="">Any Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <input type="number" step="0.01" class="form-control" name="height" placeholder="Height (cm)">
                </div>
                <div class="col-md-4 mb-3">
                    <input type="number" step="0.01" class="form-control" name="weight" placeholder="Weight (kg)">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <input type="date" class="form-control" name="dob" placeholder="Date of Birth">
                </div>
                <div class="col-md-8 mb-3">
                    <input type="text" class="form-control" name="conditions" placeholder="Medical Conditions">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
    <!-- Display Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div id="flash-message" class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Filter Form -->
    <form id="filter-form" method="GET" action="{{ url_for('staff_dashboard') }}" onkeypress="return event.keyCode != 13;">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <div class="filter-header">
                                UserID
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-userid')"></i>
                            </div>
                            <div id="filter-userid" class="filter-container">
                                <input type="text" name="user_id" value="{{ request.args.get('user_id', '') }}" placeholder="Filter UserID" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Username
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-username')"></i>
                            </div>
                            <div id="filter-username" class="filter-container">
                                <input type="text" name="username" value="{{ request.args.get('username', '') }}" placeholder="Filter Username" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Email
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-email')"></i>
                            </div>
                            <div id="filter-email" class="filter-container">
                                <input type="text" name="email" value="{{ request.args.get('email', '') }}" placeholder="Filter Email" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Address
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-address')"></i>
                            </div>
                            <div id="filter-address" class="filter-container">
                                <input type="text" name="address" value="{{ request.args.get('address', '') }}" placeholder="Filter Address" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Number
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-contact')"></i>
                            </div>
                            <div id="filter-contact" class="filter-container">
                                <input type="text" name="contact_number" value="{{ request.args.get('contact_number', '') }}" placeholder="Filter Contact" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Name
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-name')"></i>
                            </div>
                            <div id="filter-name" class="filter-container">
                                <input type="text" name="name" value="{{ request.args.get('name', '') }}" placeholder="Filter Name" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                NRIC
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-nric')"></i>
                            </div>
                            <div id="filter-nric" class="filter-container">
                                <input type="text" name="nric" value="{{ request.args.get('nric', '') }}" placeholder="Filter NRIC" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Gender
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-gender')"></i>
                            </div>
                            <div id="filter-gender" class="filter-container">
                                <select name="gender" class="form-control filter-input" onchange="submitFilter()">
                                    <option value="">Gender</option>
                                    <option value="M" {% if request.args.get('gender') == 'M' %}selected{% endif %}>Male</option>
                                    <option value="F" {% if request.args.get('gender') == 'F' %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Height
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-height')"></i>
                            </div>
                            <div id="filter-height" class="filter-container">
                                <input type="text" name="height" value="{{ request.args.get('height', '') }}" placeholder="Filter Height" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                Weight
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-weight')"></i>
                            </div>
                            <div id="filter-weight" class="filter-container">
                                <input type="text" name="weight" value="{{ request.args.get('weight', '') }}" placeholder="Filter Weight" class="form-control filter-input" oninput="submitFilter()">
                            </div>
                        </th>
                        <th>
                            <div class="filter-header">
                                DOB
                                <i class="fas fa-filter filter-icon" onclick="toggleFilter('filter-dob')"></i>
                            </div>
                            <div id="filter-dob" class="filter-container">
                                <input type="date" name="dob" value="{{ request.args.get('dob', '') }}" class="form-control filter-input" onchange="submitFilter()">
                            </div>
                        </th>
                        <th>Medical Conditions</th>
                        <th>
                            <!-- Filter Icon with Cross -->
                            <div class="clear-filters" style="display: inline-flex; align-items: center;">
                                <a href="{{ url_for('staff_dashboard') }}" class="btn btn-secondary" style="display: inline-flex; align-items: center;">
                                    <i class="fas fa-filter"></i>
                                    <i class="fas fa-times" style="margin-left: 5px;"></i>
                                </a>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="patientTableBody">
                    {% for patient in patients %}
                    <tr>
                        <td>{{ patient[0] }}</td>  <!-- UserID -->
                        <td>{{ patient[1] }}</td>  <!-- Username -->
                        <td>{{ patient[2] }}</td>  <!-- Email -->
                        <td>{{ patient[3] }}</td>  <!-- Address -->
                        <td>{{ patient[4] }}</td>  <!-- Contact Number -->
                        <td>{{ patient[5] }}</td>  <!-- Patient Name -->
                        <td>{{ patient[6] }}</td>  <!-- NRIC -->
                        <td>{{ patient[7] }}</td>  <!-- Gender -->
                        <td>{{ patient[8] }}</td>  <!-- Height -->
                        <td>{{ patient[9] }}</td>  <!-- Weight -->
                        <td>{{ patient[10] }}</td> <!-- Date of Birth -->
                        <td>{{ patient[11] }}</td> <!-- Medical Conditions -->
                        <td>
                            <a href="{{ url_for('edit_patient', patient_id=patient[0]) }}" class="btn btn-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form action="{{ url_for('delete_patient', patient_id=patient[0]) }}" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this patient?');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<script>
    // Hide the flash message after 3 seconds
    setTimeout(function() {
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            flashMessage.style.display = 'none';
        }
    }, 3000);  // 3000 milliseconds = 3 seconds

    // Function to toggle the visibility of filter inputs
    function toggleFilter(filterId) {
        const filterDiv = document.getElementById(filterId);
        const allFilters = document.querySelectorAll('.filter-container');

        // Hide all filters first
        allFilters.forEach(filter => {
            if (filter !== filterDiv) {
                filter.classList.remove('active');
            }
        });

        // Toggle the clicked filter
        filterDiv.classList.toggle('active');
    }

    // Function to hide the filters when clicking outside of them
    document.addEventListener('click', function(event) {
        const isClickInside = event.target.closest('.filter-header') || event.target.closest('.filter-container');

        if (!isClickInside) {
            const allFilters = document.querySelectorAll('.filter-container');
            allFilters.forEach(filter => {
                filter.classList.remove('active');
            });
        }
    });

    // Submit the filter form automatically when the input is changed
    function submitFilter() {
        document.getElementById('filter-form').submit();
    }

    // for advanced search
    document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggleAdvancedSearch');
    const searchForm = document.getElementById('advancedSearchForm');
    const form = document.getElementById('searchForm');
    const tableBody = document.getElementById('patientTableBody');

    toggleButton.addEventListener('click', function() {
        searchForm.style.display = searchForm.style.display === 'none' ? 'block' : 'none';
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch('{{ url_for("advanced_search") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            tableBody.innerHTML = '';
            data.forEach(patient => {
                const row = `
                    <tr>
                        <td>${patient.UserID}</td>
                        <td>${patient.Username}</td>
                        <td>${patient.Email}</td>
                        <td>${patient.Address}</td>
                        <td>${patient.ContactNumber}</td>
                        <td>${patient.PatientName}</td>
                        <td>${patient.NRIC}</td>
                        <td>${patient.PatientGender}</td>
                        <td>${patient.PatientHeight}</td>
                        <td>${patient.PatientWeight}</td>
                        <td>${patient.PatientDOB}</td>
                        <td>${patient.PatientConditions}</td>
                        <td>
                            <!-- Edit button -->
                            <a href="/edit_patient/${patient.UserID}" class="btn btn-primary">
                                <i class="bi bi-pencil"></i>
                            </a>

                            <!-- Delete button -->
                            <form action="/delete_patient/${patient.UserID}" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this patient?');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>

{% endblock %}
