{% extends 'base.html' %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/medications.css') }}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="column leftcol">
        <div class="leftcolbg"></div>
        <h1>List of Medications</h1>

        <!-- Search Form -->
        <form method="GET" action="/medications" class="mb-3">
            <div class="input-group">
                <input type="text" class="form-control" name="search" placeholder="Search by medication name" value="{{ request.args.get('search') }}">
                <button class="btn btn-primary" type="submit">Search</button>
            </div>
        </form>

        <!-- Display Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div id="flash-message" class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Manage Meds Button -->
        <button id="manageMedsBtn" class="btn btn-secondary">Manage Meds</button>

        <!-- Medications Table -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Medication ID</th>
                    <th>Name</th>
                    <th>Form</th>
                    <th>Dosage</th>
                    <th>Quantity</th>
                    <th>Indication</th>
                </tr>
            </thead>
            <tbody>
                {% for medication in medications %}
                <tr>
                    <td>{{ medication['MedID'] }}</td>
                    <td>{{ medication['name'] }}</td>
                    <td>{{ medication['form'] }}</td>
                    <td>{{ medication['dosage'] }}</td>
                    <td>{{ medication['quantity'] }}</td>
                    <td>{{ medication['indication'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if medications|length == 0 %}
            <p>No medications found.</p>
        {% endif %}
    </div>
    <div class="column rightcol"></div>
</div>

<!-- Modal for Managing Medication -->
<div id="manageMedsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Manage Medications</h2>
        <form method="POST" action="/update_medication_quantity">
            <div class="form-group">
                <label for="medicationSelect">Select Medication:</label>
                <select id="medicationSelect" name="medication_id" class="form-control" onchange="updateCurrentQuantity()">
                    {% for medication in medications %}
                    <option value="{{ medication['MedID'] }}" data-quantity="{{ medication['quantity'] }}">{{ medication['name'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="currentQuantity">Current Quantity:</label>
                <input type="number" id="currentQuantity" class="form-control" value="{{ medications[0]['quantity'] }}" readonly>
            </div>
            <div class="form-group">
                <label for="quantityChange">Adjust Quantity:</label>
                <input type="number" id="quantityChange" name="quantity_change" class="form-control" placeholder="Enter quantity to increase/decrease">
            </div>
            <button type="submit" class="btn btn-primary">Update Quantity</button>
        </form>
    </div>
</div>

<script>
    // Get modal element
    var modal = document.getElementById("manageMedsModal");
    var btn = document.getElementById("manageMedsBtn");
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal
    btn.onclick = function() {
        modal.style.display = "block";
        updateCurrentQuantity();  // Update quantity on modal open
    }

    // When the user clicks on (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Function to update the current quantity based on selected medication
    function updateCurrentQuantity() {
        var selectElement = document.getElementById("medicationSelect");
        var selectedOption = selectElement.options[selectElement.selectedIndex];
        var currentQuantity = selectedOption.getAttribute("data-quantity");
        document.getElementById("currentQuantity").value = currentQuantity;
    }

    // Hide the flash message after 3 seconds
    setTimeout(function() {
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            flashMessage.style.display = 'none';
        }
    }, 3000);  // 3000 milliseconds = 3 seconds
</script>
{% endblock %}
